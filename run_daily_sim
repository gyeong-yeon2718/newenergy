# run_daily_sim.py
# -------------------------------------------
# í•˜ë£¨ ë‹¨ìœ„ ê·œì¹™ê¸°ë°˜ AI ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ (+ ê²½ì œì„± ê³„ì‚°, ì¶©ì „í™•ëŒ€, ì—°ì†ë°©ì „)
# -------------------------------------------

import pandas as pd

# ===== 0) íŒŒì¼ ê²½ë¡œ ì„¤ì • =====
RELATIVE_PATH = "ai_dataset_single_day.xlsx"
EXCEL_PATH = RELATIVE_PATH

# ===== 1) ë°ì´í„° ë¡œë“œ & ì „ì²˜ë¦¬ =====
df = pd.read_excel(EXCEL_PATH)
print("ë°ì´í„° ë¡œë“œ ì™„ë£Œ")
print(df.head())


required_cols = {"hour", "A_load_kWh", "B_load_kWh", "SMP_price", "surplus_kWh"}
missing = required_cols - set(df.columns)
if missing:
    raise ValueError(f"í•„ìˆ˜ ì»¬ëŸ¼ì´ ì—†ìŠµë‹ˆë‹¤: {missing}")

# í”¼í¬ íŒì • ê¸°ì¤€ìš© í‰ê· /ìµœëŒ€
b_load_avg = float(df["B_load_kWh"].mean())
b_load_max = float(df["B_load_kWh"].max())

# ===== 2) ê·œì¹™ê¸°ë°˜ AI í´ë˜ìŠ¤ (ê²½ì œì„± + ì¶©ì „í™•ëŒ€ + ì—°ì†ë°©ì „) =====
class HybridEnergySystem:
    """
    Aë¶€í•˜(ì£¼íƒ), Bë¶€í•˜(ê³µì¥), ESS, ìˆ˜ì†Œì—°ë£Œì „ì§€ ê´€ë¦¬ + Phase1 ê²½ì œì„± ê³„ì‚°
    - ë‚® 10~15ì‹œ ì¶©ì „(ì‰ì—¬ì „ë ¥Ã—ë³´ì •)
    - Phase1 íŠ¸ë¦¬ê±° ì‹œ ì—°ì† ë°©ì „ ì„¸ì…˜(3ì‹œê°„)
    """

    def __init__(self,
                 initial_ess_soc=80.0,
                 initial_h2_storage=100.0,
                 ess_capacity_kwh=5000.0,       # 5MWh
                 charge_cost_won_per_kwh=110.0,
                 round_trip_eff=0.92,           # ì™•ë³µíš¨ìœ¨
                 min_margin_won_per_kwh=20.0,   # ìµœì†Œ ë§ˆì§„
                 session_length_hours=3):        # ì—°ì† ë°©ì „ ì‹œê°„(ì‹œê°„)
        # ìƒíƒœ
        self.ess_soc = float(initial_ess_soc)
        self.h2_storage = float(initial_h2_storage)
        self.discharge_session = 0               # í˜„ì¬ ë‚¨ì€ ì—°ì† ë°©ì „ ì‹œê°„
        self.SESSION_LENGTH = int(session_length_hours)

        # íŒŒë¼ë¯¸í„°
        self.ESS_CAPACITY_KWH = float(ess_capacity_kwh)
        self.CHARGE_COST_WON_PER_KWH = float(charge_cost_won_per_kwh)
        self.ROUND_TRIP_EFF = float(round_trip_eff)
        self.MIN_MARGIN = float(min_margin_won_per_kwh)

        # ì„ê³„ì¹˜
        self.B_LOAD_PEAK_RATIO = 1.5
        self.SMP_PROFIT_THRESHOLD = 150
        self.ESS_PROFIT_THRESHOLD = 30

        # ì„¤ë¹„ ìŠ¤í™
        self.ESS_MAX_DISCHARGE_KW = 500          # ì‹œê°„ë‹¹ ìµœëŒ€ ë°©ì „ëŸ‰
        self.H2_FUEL_CELL_KW = 500

        # ê²½ì œì„± ëˆ„ì 
        self.cumulative_profit = 0.0

    # --- SoC% â†” kWh ë³€í™˜ ìœ í‹¸ ---
    def _soc_to_kwh(self) -> float:
        return (self.ess_soc / 100.0) * self.ESS_CAPACITY_KWH

    def _kwh_to_soc_delta(self, kwh: float) -> float:
        return (kwh / self.ESS_CAPACITY_KWH) * 100.0

    def charge_assets(self, current_time, surplus_power_kwh):
        """
        ë‚® 10~15ì‹œ: surplusë¡œ ì¶©ì „(ì›ê°€ 0) â€” surplus ë³´ì • ê³„ìˆ˜ ì ìš©
        ì‹¬ì•¼ 0~3ì‹œ: ìˆ˜ì†Œ ì €ì¥(ë°ëª¨ìš©)
        """
        action = "IDLE"
        revenue = 0.0
        cost = 0.0
        profit = 0.0

        # âœ… ì¶©ì „ êµ¬ê°„ í™•ëŒ€ + ë³´ì •ê³„ìˆ˜(Ã—3.0)
        if current_time in range(10, 16) and surplus_power_kwh > 0:
            ess_space_kwh = max(0.0, self.ESS_CAPACITY_KWH - self._soc_to_kwh())
            charge_kwh = min(ess_space_kwh, float(surplus_power_kwh) * 3.0)
            if charge_kwh > 0:
                self.ess_soc = min(100.0, self.ess_soc + self._kwh_to_soc_delta(charge_kwh))
                cost = 0.0  # ì‰ì—¬ ì „ë ¥ ì¶©ì „ì€ 0ì›
                action = f"ACTION: CHARGE_ESS +{charge_kwh:.1f}kWh (SoC: {self.ess_soc:.1f}%)"

        # ì‹¬ì•¼ ìˆ˜ì†Œ ì €ì¥(ê²½ì œì„±ì€ ì œì™¸)
        if current_time in [0, 1, 2, 3] and surplus_power_kwh > 0:
            self.h2_storage = min(100.0, self.h2_storage + surplus_power_kwh)
            action = f"ACTION: CHARGE_HYDROGEN (Storage: {self.h2_storage:.1f}%)"

        return action, revenue, cost, profit

    def _discharge_once(self, smp_price):
        """ì—°ì† ë°©ì „ 1ì‹œê°„ ìˆ˜í–‰(ë‚´ë¶€ í—¬í¼): ìˆ˜ìµ/ì´ìµ ê³„ì‚° ë° SoC ê°ì†Œ"""
        revenue = cost = profit = 0.0
        ess_energy_kwh = self._soc_to_kwh()
        discharge_kwh = min(self.ESS_MAX_DISCHARGE_KW, ess_energy_kwh)
        if discharge_kwh <= 0:
            return "IDLE (ESS ì”ëŸ‰ ë¶€ì¡±)", 0.0, 0.0, 0.0

        sellable_kwh = discharge_kwh * self.ROUND_TRIP_EFF
        revenue = sellable_kwh * float(smp_price)
        cost = 0.0  # surplus ì›ê°€ 0 ê°€ì •
        profit = revenue - cost

        self.ess_soc = max(0.0, self.ess_soc - self._kwh_to_soc_delta(discharge_kwh))
        self.cumulative_profit += profit
        return (f"[PHASE 1] ESS ë°©ì „ {discharge_kwh:.1f}kWh "
                f"(ìœ íš¨ {sellable_kwh:.1f}kWh, SoC {self.ess_soc:.1f}%)"), revenue, cost, profit

    def make_ai_decision(self, current_time, b_load_power, b_load_average, smp_price):
        revenue = cost = profit = 0.0

        # âœ… ì—°ì† ë°©ì „ ì„¸ì…˜ì´ ì§„í–‰ ì¤‘ì´ë©´ ê³„ì† ë°©ì „ (SMPê°€ ì•„ì£¼ ë‚®ì§€ ì•Šì€ í•œ)
        if self.discharge_session > 0:
            self.discharge_session -= 1
            msg, revenue, cost, profit = self._discharge_once(smp_price)
            return f"[PHASE 1-ì—°ì†ë°©ì „] {msg} (ì”ì—¬ {self.discharge_session}h)", revenue, cost, profit

        # Phase 2 (ë™ì¼)
        is_b_peak_detected = (b_load_power >= b_load_average * self.B_LOAD_PEAK_RATIO)
        if is_b_peak_detected:
            if b_load_power > self.ESS_MAX_DISCHARGE_KW:
                if self.h2_storage > 0:
                    return "[PHASE 2] Bë¶€í•˜ í”¼í¬ ê°ì§€! ìˆ˜ì†Œ ì—°ë£Œì „ì§€ ê°€ë™!", revenue, cost, profit
                else:
                    return "[ERROR] Bë¶€í•˜ í”¼í¬ ê°ì§€! ì‚¬ìš©ê°€ëŠ¥í•œ ìˆ˜ì†Œ ì—†ìŒ!", revenue, cost, profit
            else:
                if self.ess_soc > (b_load_power / self.ESS_MAX_DISCHARGE_KW * 100):
                    return "[PHASE 1] Bë¶€í•˜ í”¼í¬ ê°ì§€. ESSë¡œ ëŒ€ì‘í•©ë‹ˆë‹¤.", revenue, cost, profit
                else:
                    return "[ERROR] Bë¶€í•˜ í”¼í¬ ê°ì§€! ESS ì”ëŸ‰ ë¶€ì¡±!", revenue, cost, profit

        # Phase 1 (ê²½ì œì„± íŠ¸ë¦¬ê±°)
        is_ess_ready = (self.ess_soc > self.ESS_PROFIT_THRESHOLD)
        is_smp_high = (smp_price > self.SMP_PROFIT_THRESHOLD)

        if is_ess_ready and is_smp_high:
            # ë°©ì „ ì„¸ì…˜ ì‹œì‘: í˜„ì¬ í¬í•¨ 1h + ì´í›„ (SESSION_LENGTH-1)h
            self.discharge_session = max(self.SESSION_LENGTH - 1, 0)
            msg, revenue, cost, profit = self._discharge_once(smp_price)
            return f"[PHASE 1-ì„¸ì…˜ì‹œì‘] {msg} (ì¶”ê°€ {self.discharge_session}h ì˜ˆì •)", revenue, cost, profit

        return "IDLE (Bë¶€í•˜ ì•ˆì •, SMP ë‚®ìŒ ë˜ëŠ” ESS ì”ëŸ‰ ë¶€ì¡±)", revenue, cost, profit


# ===== 3) ì‹œë®¬ë ˆì´ì…˜ ì„¤ì • =====
system = HybridEnergySystem(
    initial_ess_soc=50.0,            # ì´ˆê¸° SoC ìƒí–¥
    initial_h2_storage=100.0,
    ess_capacity_kwh=5000.0,         # 5MWh
    charge_cost_won_per_kwh=110.0,   # (í˜„ì¬ëŠ” surplusë§Œ ì¶©ì „í•˜ë¯€ë¡œ ì›ê°€ 0 ì²˜ë¦¬)
    round_trip_eff=0.92,
    min_margin_won_per_kwh=20.0,
    session_length_hours=3           # ì—°ì† ë°©ì „ 3ì‹œê°„
)

# â–¶ ì˜µì…˜: Phase 2ê°€ ìµœì†Œ 1íšŒ ë‚˜ì˜¤ê²Œ ë™ì  ì„ê³„ì¹˜ ì„¤ì • (ì‹œì—°ìš©)
FORCE_PHASE2_ONCE = True
if FORCE_PHASE2_ONCE:
    dynamic_ratio = (b_load_max / b_load_avg) * 0.98
    system.B_LOAD_PEAK_RATIO = dynamic_ratio
    print(f"âš™ï¸  B_LOAD_PEAK_RATIO ë™ì  ì„¤ì •: {dynamic_ratio:.3f} (ê¸°ë³¸ 1.500 â†’ ë™ì ê°’)")

# ===== 4) 24ì‹œê°„ ë£¨í”„ ì‹¤í–‰ =====
logs = []
cum_profit = 0.0

for _, r in df.iterrows():
    hour = int(r["hour"])
    surplus = float(r["surplus_kWh"])
    smp = float(r["SMP_price"])
    b_load = float(r["B_load_kWh"])

    # (1) ì‰ì—¬ì „ë ¥ ì¶©ì „ (ì›ê°€ 0)
    charge_action, ch_rev, ch_cost, ch_profit = system.charge_assets(hour, surplus)

    # (2) ìš´ì˜ íŒë‹¨ (Phase1ì´ë©´ ì—°ì†ë°©ì „ í¬í•¨)
    decision, revenue, cost, profit = system.make_ai_decision(hour, b_load, b_load_avg, smp)

    # ì‹œê°„ëŒ€ ìˆœì´ìµ(ì¶©ì „ë¹„ìš© ì°¨ê°; í˜„ì¬ ch_cost=0)
    net_profit = (ch_profit + profit) - ch_cost
    cum_profit += net_profit

    logs.append({
        "hour": hour,
        "B_load_kWh": b_load,
        "SMP_price": smp,
        "surplus_kWh": surplus,
        "decision": decision,
        "charge_action": charge_action,
        "ess_soc(%)": round(system.ess_soc, 2),
        "h2_storage(%)": round(system.h2_storage, 2),
        "revenue_won": round(revenue, 0),
        "cost_won": round(ch_cost + cost, 0),
        "profit_won": round(net_profit, 0),
        "cum_profit_won": round(cum_profit, 0)
    })

result = pd.DataFrame(logs)

# ===== 5) ê²°ê³¼ ì €ì¥ & ìš”ì•½ =====
OUT_XLSX = "AI_Daily_Operation_Log.xlsx"
OUT_CSV = "AI_Daily_Operation_Log.csv"
result.to_excel(OUT_XLSX, index=False)
result.to_csv(OUT_CSV, index=False, encoding="utf-8-sig")

print(f"\nğŸ’¾ ê²°ê³¼ ì €ì¥ ì™„ë£Œ: {OUT_XLSX}, {OUT_CSV}")
print(result.head(10)[["hour","decision","charge_action","revenue_won","cost_won","profit_won","cum_profit_won"]])

summary = result["decision"].value_counts()
print("\n=== ì˜ì‚¬ê²°ì • ìš”ì•½ ===")
for k, v in summary.items():
    print(f"{k}: {v}ì‹œê°„")

phase2_hours = result.loc[result["decision"].str.contains("PHASE 2", na=False), "hour"].tolist()
print("\nPHASE 2 ë°œìƒ ì‹œê°:", phase2_hours if phase2_hours else "ì—†ìŒ")
print("ì´ ëˆ„ì  ì´ìµ(ì›):", int(result["cum_profit_won"].iloc[-1]))
